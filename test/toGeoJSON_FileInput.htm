<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link href='css/style.css' type='text/css' rel='stylesheet' />
        <link href='css/site.css' type='text/css' rel='stylesheet' />
        <title>toGeoJSON</title>
    </head>
    <body>
        <div class='col8 margin2 pad2'>
            <h1 class='center'>
                <a href='https://github.com/tmcw/togeojson'>toGeoJSON
                    turns KML &amp; GPX</a> into <a target='_blank' href='http://geojson.org/'>GeoJSON</a>
            </h1>
            <div class='clearfix col12'>
                
                <div class='col6'>
                    <strong class='h30'>Choose a file to convert</strong>
                    
                    <div style="float: left; margin-right: 5px;">Choose File Type:</div>
                    <select style="width: 80px;" id='format' >
                        <option value='kml'>KML</option>
                        <option value='gpx'>GPX</option>
                    </select>

                    <!-- <br> -->
                    <form>
                        <div>  <!-- <div style="font: 700 0.9rem sans-serif; margin-bottom: 3px;">KML</div> -->
                            <input id='filein' name="input" type="file" multiple="true" accept=".kml">
                            <div style="font-size: 0.85rem; font-style: italic; margin-top: 3px;">Pick a <span id="kmlOrGpxText">Kml</span> file to convert to GeoJSON.</div>
                        </div>
                        <br>
                    </form>
                
                <!-- <textarea id='in'>

                </textarea> -->
                </div>
                <div class='col6'>
                    <strong class='h30'>GeoJSON</strong>
                    <textarea id='output'></textarea></div>
            </div>
            <div class='pad2 center'>
                <a class='button' href='https://raw.githubusercontent.com/mapbox/togeojson/master/togeojson.js' download='togeojson.js'>â¬‡ togeojson.js <small>less than 10 kB minified</small></a>
                <br /><br />
                <small>
                    <a href='http://github.com/tmcw/togeojson'>or clone &amp; contribute on github</a>
                </small>
            </div>
            <div class='clearfix col12'>
                <div class='col6 pad2'>
                    <p>
                    toGeoJSON is a simple way to use KML and GPX formats with
                    modern web tools like Leaflet and MapBox. It's simple,
                    written in plain, dependency-free JavaScript and designed
                    to work across browsers and in node.js.
                    </p>
                    <p>
                    Use this page to test it out, or download it to integrate
                    into your application.
                    </p>
                </div>
                <div class='col6 pad2'>
                    <h3>KML</h3>
                    <p>
                    <ul class='features'>
                        <li>LineString, Polygon, MultiPolygon, MultiLineString, Point, MultiGeometry</li>
                        <li>ExtendedData, SimpleData, name, description</li>
                    </ul>
                    </p>
                    <h3>GPX</h3>
                    <p>
                    <ul class='features'>
                        <li>Tracks, Routes, and Waypoints</li>
                        <li>Standard metadata</li>
                    </ul>
                    </p>
                </div>
            </div>
        </div>
        <div id='output'></div>
        <script src='../lib/togeojson.js'></script>

        <!-- <script type="module">
            import { kml } from "https://unpkg.com/@tmcw/togeojson?module";
          
            fetch("test/data/linestring.kml")
              .then(function(response) {
                return response.text();
              })
              .then(function(xml) {
                console.log(kml(new DOMParser().parseFromString(xml, "text/xml")));
              });
        </script> -->


        <script>
            // import { kmlGen } from "https://unpkg.com/@tmcw/togeojson?module";
            // import { gpxGen } from "https://unpkg.com/@tmcw/togeojson?module";
            // var input = document.getElementById('in');
            var kmlOrGpxText = document.getElementById('kmlOrGpxText');
            var out = document.getElementById('output');
            var format = document.getElementById('format');
            var filein = document.getElementById('filein');

            format.onchange = function() {
                // do something when different format is selected
                kmlOrGpxText.innerHTML = format.value.toUpperCase();
                filein.setAttribute("accept", "."+format.value);
            };

            filein.onchange = update = function(event) {
                // out.value = JSON.stringify(toGeoJSON[format.value]((new DOMParser()).parseFromString(filein.value, 'text/xml')), null, 4);

                const fileList = event.target.files;
                console.log(fileList);

                // console.log('File type and name: ', filein.value.type, filein.value);

                let gj = { type: "FeatureCollection", features: [] };
                
                for (let file of fileList) {
                    // let text = "";
                    // let text = await read(file);
                    // let text = read(file);
                    // fetch("test/data/linestring.kml")
                    // .then(function(response) {
                    // return response.text();
                    // })
                    // .then(function(xml) {
                    //     console.log(kml(new DOMParser().parseFromString(xml, "text/xml")));
                    // });

                    const reader = new FileReader();
                    reader.addEventListener('load', (event) => {
                        // text = event.target.result;
                        // console.log("file text: ", text);
                        let text = event.target.result;

                        // console.log(kml(new DOMParser().parseFromString(text, "text/xml")));

                        let dom = new DOMParser().parseFromString(text, "application/xml");

                        let error = dom.querySelector("parsererror");
                        if (error) throw new Error(error.innerText);

                        switch (format.value) {
                            case 'kml':
                                gj.features.push(toGeoJSON.kml(dom));
                                break;
                            case 'gpx':
                                gj.features.push(toGeoJSON.gpx(dom));
                                break;
                            default:
                                break;
                        }
                        out.value = JSON.stringify(gj, null, 4);
                    });
                    // reader.readAsDataURL(file);
                    reader.readAsText(file);

                    // console.log("file text: ", text);


                }
                
                
                
                // return gj;
            };

            update();
        </script>
        <!-- <script type="text/javascript">
            var _gauges = _gauges || [];
            (function() {
                var t   = document.createElement('script');
                t.type  = 'text/javascript';
                t.async = true;
                t.id    = 'gauges-tracker';
                t.setAttribute('data-site-id', '4e36eb1ef5a1f53d6f000001');
                t.src = '//secure.gaug.es/track.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(t, s);
            })();
        </script> -->
    </body>
</html>
